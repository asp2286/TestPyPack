name: Publish

on:
  push:
    tags:
      - "v*"

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Validate tag and set version
        run: |
          python - <<'PY'
          import os
          import re
          import sys

          tag = os.environ.get("GITHUB_REF_NAME", "")
          if not re.fullmatch(r"v\d+\.\d+\.\d+", tag):
              print(f"Invalid tag '{tag}'. Expected vX.Y.Z", file=sys.stderr)
              sys.exit(1)

          version = tag[1:]
          path = "pyproject.toml"
          with open(path, "r", encoding="utf-8") as f:
              content = f.read()

          new_content, count = re.subn(
              r"(?m)^version\s*=\s*\"[^\"]+\"\s*$",
              f'version = "{version}"',
              content,
              count=1,
          )

          if count != 1:
              print("Failed to update version in pyproject.toml", file=sys.stderr)
              sys.exit(1)

          with open(path, "w", encoding="utf-8") as f:
              f.write(new_content)

          with open(os.environ["GITHUB_ENV"], "a", encoding="utf-8") as f:
              f.write(f"VERSION={version}\n")
          PY

      - name: Install build tools
        run: |
          python -m pip install --upgrade pip
          python -m pip install build twine

      - name: Build
        run: python -m build

      - name: Upload to Artifactory
        env:
          TWINE_USERNAME: ${{ secrets.JFROG_USERNAME }}
          TWINE_PASSWORD: ${{ secrets.JFROG_ACCESS_TOKEN }}
        run: |
          python -m twine upload \
            --repository-url https://iitech.jfrog.io/artifactory/api/pypi/pypi-local \
            dist/*

      - name: Publish summary
        run: echo "Uploaded version ${VERSION} to repository pypi-local"
